<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Visualization</title>
        <link href="https://cdn.anychart.com/releases/8.11.0/css/anychart-ui.min.css" rel="stylesheet" type="text/css">
        <link href="https://cdn.anychart.com/releases/8.11.0/fonts/css/anychart-font.min.css" rel="stylesheet" type="text/css">  
        <script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-core.min.js"></script>
        <script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-stock.min.js"></script>
        <script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-data-adapter.min.js"></script>
        <script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-ui.min.js"></script>
        <script src="https://cdn.anychart.com/releases/8.11.0/themes/dark_glamour.min.js"></script>
        <style type="text/css">
            html,
            body,
            #container {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }
        </style>
    </head>
    <body>
        <div id="container"></div>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script>
            // Retrieve the stored values from localStorage
            const selectedStock = localStorage.getItem("selectedStock");
            const selectedTimeFrame = localStorage.getItem("selectedTimeFrame");
            var url = 'https://www.alphavantage.co/query?function=' + selectedTimeFrame + '&symbol=' + selectedStock + '&apikey=C3XZTDGXRR6K8AZS&datatype=csv';

            if (selectedTimeFrame == 'TIME_SERIES_INTRADAY_EXTENDED') {
                url = url + '&interval=15min&slice=year1month1';
            }
            anychart.onDocumentReady(function () {
                anychart.data.loadCsvFile(
                url,
                    function (data) {
                        // create a data table with the loaded data
                        var dataTable = anychart.data.table();
                        dataTable.addData(data);

                        // map the loaded data for the candlestick series
                        var mapping = dataTable.mapAs({
                            open: 1,
                            high: 2,
                            low: 3,
                            close:4
                        });

                        // create a stock chart
                        var chart = anychart.stock();

                        // change the color theme
                        anychart.theme('darkGlamour');

                        // create the chart plot
                        var plot = chart.plot(0);

                        // set the grid settings
                        plot.yGrid(true).xGrid(true).yMinorGrid(true).xMinorGrid(true);
                        // create the candlestick series
                        var series = plot.candlestick(mapping);
                        series.name(selectedStock);
                        series.legendItem().iconType('rising-falling');

                        // create a range picker
                        var rangePicker = anychart.ui.rangePicker();
                        rangePicker.render(chart);

                        // create a range selector
                        var rangeSelector = anychart.ui.rangeSelector();
                        rangeSelector.render(chart);

                        // modify the color of the candlesticks
                        series.fallingFill("#FF0D0D");
                        series.fallingStroke("#FF0D0D");
                        series.risingFill("#43FF43");
                        series.risingStroke("#43FF43");

                        // add a second plot to show MACD values
                        var indicatorPlot = chart.plot(1);

                        // map the MACD values
                        var macdIndicator = indicatorPlot.macd(mapping);

                        // set the histogram series
                        macdIndicator.histogramSeries('area');
                        macdIndicator.histogramSeries().normal().fill('green .3').stroke('green');
                        macdIndicator.histogramSeries().normal().negativeFill('red .3').negativeStroke('red');

                        // set the second plot's height
                        indicatorPlot.height('30%');

                        // set the chart display for the selected date/time range
                        chart.selectRange('2023-01-26', '2023-06-20');

                        // set the title of the chart
                        chart.title(selectedStock +  ' Stock Chart');

                        // set the container id for the chart
                        chart.container('container');

                        // initiate the chart drawing
                        chart.draw();

                    });
            });


        </script>
    </body>
</html>